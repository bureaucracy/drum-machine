var Sample=function(){this.sound=false;this.name=false;this.context=new(window.AudioContext||window.webkitAudioContext);this.bpm=120};function toArrBuffer(base64){var binaryString=atob(base64);var len=binaryString.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)}return bytes.buffer}Sample.prototype={_toArrBuffer:function(data){var binaryString=atob(data);var len=binaryString.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)}this.sound=bytes.buffer},load:function(next){var self=this;localforage.getItem(this.name,function(err,audio){if(err){console.log("error: ",err);return}self.filename=audio.name;self._toArrBuffer(audio.data);next(self.sound)})},play:function(){var source=this.context.createBufferSource();var self=this;if(!this.name){console.log("no sound name/sample provided");return}this.load(function(){self.context.decodeAudioData(self.sound,function(buffer){source.buffer=buffer;source.connect(self.context.destination);source.start(0)})})}};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame;var Track=function(){this.bpm=120;this.isPlaying=false;this.sounds={};this.samples={};this.timestamp=(new Date).getTime()};Track.prototype={_getBPM:function(){var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;var sixteenthNote=Math.round(qtr/4*1e5)/1e5;return Math.round(sixteenthNote*1e5)/1e5},add:function(id,next){var self=this;this.sounds[id]={};this.samples[id]=new Sample;this.samples[id].name="audio-"+id;this.samples[id].bpm=this._getBPM();this.samples[id].load(function(){for(var i=0;i<16;i++){self.sounds[id][i]=false}console.log("loaded into track ",self.sounds);next(true)})},stop:function(){var notes=document.querySelectorAll(".note");for(var i=0;i<notes.length;i++){notes[i].classList.remove("playing")}this.start=0;this.play=null},loop:function(){var counter=0;var self=this;var bpm=this._getBPM();this.isPlaying=true;this.play=function(){try{requestAnimationFrame(self.play)}catch(err){}var now=(new Date).getTime();var delta=now-self.timestamp;if(delta>=bpm){self.timestamp=now-delta%bpm;document.querySelector("#note-"+counter).classList.remove("playing");for(var i=0;i<Object.keys(self.samples).length;i++){if(self.sounds[i][counter]){self.samples[i].play()}}counter++;if(counter>15){counter=0}document.querySelector("#note-"+counter).classList.add("playing")}};this.play()}};(function(){var audioTotal=0;var track=new Track;function generateButtons(row){var id=row.getAttribute("sound");var bars=document.createElement("div");bars.id="bars";for(var i=0;i<16;i++){var bar=document.createElement("button");pos=i;bar.classList.add("bar");bar.id="bar-"+i;bar.setAttribute("pos",i);bar.onclick=function(){if(this.getAttribute("on")==="true"){this.setAttribute("on",false);track.sounds[id][this.getAttribute("pos")]=false}else{this.setAttribute("on",true);track.sounds[id][this.getAttribute("pos")]=true}};bars.appendChild(bar)}row.appendChild(bars)}function loadAudio(){var machine=document.querySelector("#machine");var footer=document.querySelector("#footer");var counter=0;for(var i=0;i<audioTotal;i++){track.add(i,function(){var sampleRow=document.createElement("div");sampleRow.classList.add("sample");sampleRow.id="sample-"+counter;sampleRow.setAttribute("sound",counter);var span=document.createElement("span");span.textContent=track.samples[counter].filename;sampleRow.appendChild(span);generateButtons(sampleRow);machine.appendChild(sampleRow);counter++})}document.querySelector("#bpm").onchange=function(){if(isNaN(parseInt(this.value,10))){this.value=120}track.bpm=this.value;if(track.isPlaying){track.stop();track.loop()}};document.querySelector("#play").onclick=function(){track.loop()};document.querySelector("#pause").onclick=function(){track.stop()};var notes=document.createElement("div");notes.id="notes";for(var i=0;i<16;i++){var note=document.createElement("div");note.id="note-"+i;note.classList.add("note");notes.appendChild(note)}machine.appendChild(notes);footer.appendChild(play);footer.appendChild(bpm);document.querySelector("#loader").classList.add("hide")}function downloadAudio(){var http=new XMLHttpRequest;http.responseType="json";http.onreadystatechange=function(){if(http.readyState===4&&http.status===200){var audioArr=http.response;for(var i=0;i<audioArr.length;i++){var id=i;if(audioArr[id]){localforage.setItem("audio-"+i,{data:audioArr[id].data,name:audioArr[id].name},function(err){if(err){console.log("error: ",err)}})}}localforage.setItem("downloaded",audioArr.length,function(err){if(err){console.log("error: ",err);return}audioTotal=audioArr.length;loadAudio()})}};http.open("GET","/audio",true);http.send()}function init(){localforage.getItem("downloaded",function(err,total){if(err||!total){downloadAudio();return}audioTotal=total;loadAudio()})}init()}).call(this);