var Effect=function(){};Effect.distortionCurve=function(amount){var samples=44100;var curve=new Float32Array(samples);var deg=Math.PI/180;for(var i=0;i<samples;i++){var x=i*2/samples-1;curve[i]=(3+amount)*x*20*deg/(Math.PI+amount*Math.abs(x))}return curve};var Sample=function(){this.sound=false;this.name=false;this._volume=1;this._delay=0;this._distortion=0;document.querySelector("#wrapper").addEventListener("play",this._playAudio)};Sample.prototype={_playAudio:function(event){event.detail.sample.play(function(){document.querySelector("#wrapper").removeEventListener("play",this._playAudio)})},_toArrBuffer:function(data){var binaryString=atob(data);var len=binaryString.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)}this.sound=bytes.buffer},set volume(value){this._volume=value},get volume(){return this._volume},set distortion(value){this._distortion=value},get distortion(){return this._distortion},load:function(next){localforage.getItem(this.name,function(err,audio){if(err){console.log("error: ",err);return}this.filename=audio.name;this.base64=audio.data;next(this.filename)}.bind(this))},play:function(next){document.querySelector("#wrapper").addEventListener("play",this._playAudio);var source=audioContext.createBufferSource();var gainNode=audioContext.createGain();var distortionNode=audioContext.createWaveShaper();if(!this.name){console.log("no sound name/sample provided");return}this._toArrBuffer(this.base64);audioContext.decodeAudioData(this.sound,function(buffer){if(!this.buffer){this.buffer=buffer}source.buffer=this.buffer;source.connect(gainNode);gainNode.connect(distortionNode);distortionNode.connect(audioContext.destination);gainNode.gain.value=this._volume;distortionNode.curve=Effect.distortionCurve(this._distortion);distortionNode.oversample="2x";source.start(0);next(true)}.bind(this))}};var Track=function(){this.sounds={};this.samples={};this.timestamp=(new Date).getTime();this.currentNote=16;this.counter=0;this.id=false;var wrapper=document.querySelector("#wrapper");wrapper.addEventListener("track",playTrack.bind(this));wrapper.removeEventListener("track",playTrack.bind(this));function playTrack(event){if(this.currentNote===event.detail.note){this.play()}}};Track.prototype={_playTrack:function(event){if(this.currentNote===event.detail.note){this.play()}},_emit:function(what,detail){var event=new CustomEvent(what,{detail:detail});document.querySelector("#wrapper").dispatchEvent(event)},add:function(id,next){this.sounds[id]={};this.samples[id]=new Sample;this.samples[id].name="audio-"+id;this.samples[id].load(function(filename){for(var i=0;i<16;i++){this.sounds[id][i]=false}next(filename)}.bind(this))},setVolumeUp:function(id){this.samples[id].volume=Math.round((this.samples[id].volume+.1)*10)/10;document.querySelector("#volume-down-"+this.id+"-"+id).removeAttribute("disabled");if(this.samples[id].volume>=1){document.querySelector("#volume-up-"+this.id+"-"+id).setAttribute("disabled",true);this.samples[id].volume=1}else{document.querySelector("#volume-up-"+this.id+"-"+id).removeAttribute("disabled")}return this.samples[id].volume},setVolumeDown:function(id){this.samples[id].volume=Math.round((this.samples[id].volume-.1)*10)/10;document.querySelector("#volume-up-"+this.id+"-"+id).removeAttribute("disabled");if(this.samples[id].volume<=0){document.querySelector("#volume-down-"+this.id+"-"+id).setAttribute("disabled",true);this.samples[id].volume=0}else{document.querySelector("#volume-down-"+this.id+"-"+id).removeAttribute("disabled")}return this.samples[id].volume},setDistortionUp:function(id){this.samples[id].distortion=this.samples[id].distortion+100;document.querySelector("#distortion-down-"+this.id+"-"+id).removeAttribute("disabled");if(this.samples[id].distortion>=1e3){document.querySelector("#distortion-up-"+this.id+"-"+id).setAttribute("disabled",true);this.samples[id].distortion=1e3}else{document.querySelector("#distortion-up-"+this.id+"-"+id).removeAttribute("disabled")}return this.samples[id].distortion},setDistortionDown:function(id){this.samples[id].distortion=this.samples[id].distortion-100;document.querySelector("#distortion-up-"+this.id+"-"+id).removeAttribute("disabled");if(this.samples[id].distortion<=0){document.querySelector("#distortion-down-"+this.id+"-"+id).setAttribute("disabled",true);this.samples[id].distortion=0}else{document.querySelector("#distortion-down-"+this.id+"-"+id).removeAttribute("disabled")}return this.samples[id].distortion},toggleEditRow:function(id,button){var edit=document.querySelector("#edits-"+this.id+"-"+id);if(this.samples[id].showEditRow){edit.classList.add("hide");button.textContent="+";this.samples[id].showEditRow=false}else{edit.classList.remove("hide");button.textContent="-";this.samples[id].showEditRow=true}},stop:function(){var notes=document.querySelectorAll(".note");for(var i=0;i<notes.length;i++){notes[i].classList.remove("playing")}this.counter=0},play:function(){document.querySelector("#note-"+this.id+"-"+this.counter).classList.remove("playing");for(var i=0;i<Object.keys(this.samples).length;i++){if(this.sounds[i][this.counter]){var detail={id:this.id,note:this.currentNote,sample:this.samples[i]};this._emit("play",detail)}}this.counter++;if(this.counter>31){this.counter=0}document.querySelector("#note-"+this.id+"-"+this.counter).classList.add("playing")}};var Sequencer=function(){this.bpm=120;this.tracks={};this.counter=0;this.isPlaying=false;this.trackTotal=0;this.trackMax=5;this._notes=[2,4,8,16,32];function setBPM(nt){var noteCalc=nt/4;var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;if(noteCalc>0){noteCalc=qtr/noteCalc}else{noteCalc=qtr*noteCalc}return Math.round(noteCalc*1e5)/1e5}for(var i=0;i<this._notes.length;i++){this["timestamp"+this._notes[i]]=(new Date).getTime();Sequencer.prototype["_getBPM"+this._notes[i]]=setBPM.bind(this,this._notes[i])}};Sequencer.prototype={_generateNoteSelector:function(){var select=document.createElement("select");select.classList.add("notes-current");select.id="note-change-"+this.counter;select.setAttribute("data-id",this.counter);var notes=this._notes;var option;for(var i=0;i<notes.length;i++){option=document.createElement("option");option.value=notes[i];option.textContent="1/"+notes[i];if(notes[i]===16){option.setAttribute("selected",true)}select.appendChild(option)}return select},addTrack:function(){this.trackTotal++;if(this.trackTotal>this.trackMax){this.trackTotal=this.trackMax}if(this.trackTotal>this.trackMax){document.querySelector("#new-track").setAttribute("disabled",true);return}else{document.querySelector("#new-track").removeAttribute("disabled")}var track=new Track;this.counter++;track.id=this.counter;function setClick(id){if(this.getAttribute("on")==="true"){this.setAttribute("on",false);track.sounds[id][this.getAttribute("pos")]=false}else{this.setAttribute("on",true);track.sounds[id][this.getAttribute("pos")]=true}}function generateButtons(row){var id=row.getAttribute("sound");var bars=document.createElement("div");bars.classList.add("bars-row");for(var i=0;i<32;i++){var bar=document.createElement("button");pos=i;bar.classList.add("bar");bar.id="bar-"+i;bar.setAttribute("pos",i);bar.onclick=setClick.bind(bar,id);bars.appendChild(bar)}row.appendChild(bars)}var machine=document.querySelector("#machine");var footer=document.querySelector("#footer");var sequencerRow=document.createElement("div");sequencerRow.classList.add("sequencer");sequencerRow.id="sequencer-"+this.counter;var remove=document.createElement("button");remove.classList.add("delete");remove.setAttribute("data-id",this.counter);remove.id="delete-"+this.counter;remove.textContent="x";sequencerRow.appendChild(remove);var notes=document.createElement("div");notes.classList.add("notes");for(var i=0;i<32;i++){var span=document.createElement("span");span.textContent=i+1;var note=document.createElement("div");note.id="note-"+this.counter+"-"+i;note.classList.add("note");if(i===0){note.classList.add("playing")}note.appendChild(span);notes.appendChild(note)}sequencerRow.appendChild(notes);sequencerRow.appendChild(this._generateNoteSelector());var counter=0;function addSample(j){track.add(j,function(filename){var sampleRow=document.createElement("div");sampleRow.classList.add("sample");sampleRow.id="sample-"+this.counter+"-"+counter;sampleRow.setAttribute("sound",counter);var span=document.createElement("span");span.textContent=filename;sampleRow.appendChild(span);var button=document.createElement("button");button.classList.add("toggle-edits");button.setAttribute("data-edits","edits-"+this.counter+"-"+counter);button.textContent="+";button.onclick=function(){var id=this.parentNode.getAttribute("sound");track.toggleEditRow(id,this)};sampleRow.appendChild(button);generateButtons.call(this,sampleRow);sequencerRow.appendChild(sampleRow);var editsRow=document.createElement("div");editsRow.classList.add("edits");editsRow.id="edits-"+this.counter+"-"+counter;editsRow.setAttribute("sound",counter);editsRow.classList.add("hide");var span=document.createElement("span");span.id="volume-"+this.counter+"-"+counter;span.textContent=1;editsRow.appendChild(span);button=document.createElement("button");button.classList.add("volume");button.classList.add("up");button.textContent="vol +";button.id="volume-up-"+this.counter+"-"+counter;button.setAttribute("data-track",span.id);button.setAttribute("disabled",true);button.onclick=function(){var id=this.parentNode.getAttribute("sound");var vol=track.setVolumeUp(id,"up");document.querySelector("#"+this.getAttribute("data-track")).textContent=vol};editsRow.appendChild(button);button=document.createElement("button");button.classList.add("volume");button.classList.add("down");button.textContent="vol -";button.id="volume-down-"+this.counter+"-"+counter;button.setAttribute("data-track",span.id);button.onclick=function(){var id=this.parentNode.getAttribute("sound");var vol=track.setVolumeDown(id,"down");document.querySelector("#"+this.getAttribute("data-track")).textContent=vol};editsRow.appendChild(button);span=document.createElement("span");span.id="delay-"+this.counter+"-"+counter;span.textContent=0;editsRow.appendChild(span);button=document.createElement("button");button.classList.add("distortion");button.classList.add("up");button.textContent="distort +";button.id="distortion-up-"+this.counter+"-"+counter;button.setAttribute("data-track",span.id);button.onclick=function(){var id=this.parentNode.getAttribute("sound");var delay=track.setDistortionUp(id,"up");document.querySelector("#"+this.getAttribute("data-track")).textContent=delay};editsRow.appendChild(button);button=document.createElement("button");button.classList.add("distortion");button.classList.add("down");button.textContent="distort -";button.id="distortion-down-"+this.counter+"-"+counter;button.setAttribute("data-track",span.id);button.setAttribute("disabled",true);button.onclick=function(){var id=this.parentNode.getAttribute("sound");var delay=track.setDistortionDown(id,"down");document.querySelector("#"+this.getAttribute("data-track")).textContent=delay};editsRow.appendChild(button);sequencerRow.appendChild(editsRow);counter++}.bind(this))}for(var j=0;j<this.audioTotal;j++){addSample.call(this,j)}this.tracks[this.counter]=track;machine.appendChild(sequencerRow);this.play()},stop:function(){this.isPlaying=false;for(var track in this.tracks){this.tracks[track].stop()}this.playTrack=null},_emit:function(what,detail){var event=new CustomEvent(what,{detail:detail});document.querySelector("#wrapper").dispatchEvent(event)},play:function(){this.stop();this.isPlaying=true;function setTimer(notes){var now=(new Date).getTime();var delta={};for(var i=0;i<this._notes.length;i++){var note=this._notes[i];delta[note]=now-this["timestamp"+note];if(delta[note]>=this["_getBPM"+note]()){this["timestamp"+note]=now-delta[note]%this["_getBPM"+note]();this._emit("track",{note:note})}}}this.playTrack=function(){try{requestAnimationFrame(this.playTrack.bind(this))}catch(err){}setTimer.call(this)};this.playTrack()},remove:function(id){this.trackTotal--;if(this.trackTotal>0){this.trackTotal=0}if(this.trackTotal<=this.trackMax){document.querySelector("#new-track").removeAttribute("disabled")}this.tracks[id].stop();delete this.tracks[id];var seq=document.querySelector("#sequencer-"+id);seq.parentNode.removeChild(seq)}};(function(){var Context=window.AudioContext||window.webkitAudioContext;window.audioContext=new Context;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;var sequencer=new Sequencer;sequencer.audioTotal=0;function setNoteChanger(){var id=sequencer.counter;document.querySelector("#note-change-"+id).onchange=function(ev){sequencer.tracks[ev.target.getAttribute("data-id")].currentNote=parseInt(this.value,10);if(sequencer.isPlaying){sequencer.play()}};document.querySelector("#delete-"+id).onclick=function(ev){sequencer.remove(ev.target.getAttribute("data-id"))}}function loadAudio(){sequencer.addTrack();setNoteChanger();document.querySelector("#bpm").onchange=function(){var bpm=parseInt(this.value,10);if(isNaN(bpm)||bpm<10){this.value=120}if(bpm>300){this.value=300}sequencer.bpm=this.value;if(sequencer.isPlaying){sequencer.play()}};document.querySelector(".notes-current").onchange=function(ev){sequencer.tracks[ev.target.getAttribute("data-id")].currentNote=parseInt(this.value,10);if(sequencer.isPlaying){sequencer.play()}};document.querySelector("#new-track").onclick=function(){sequencer.addTrack();setNoteChanger()};document.querySelector("#play").onclick=function(){sequencer.play()};document.querySelector("#pause").onclick=function(){sequencer.stop()};document.querySelector("#reset").onclick=function(){localforage.clear(function(err){if(err){console.log(err);return}document.location.href="/"})};document.querySelector("#loader").classList.add("hide")}function downloadAudio(){var http=new XMLHttpRequest;http.responseType="json";http.onreadystatechange=function(){if(http.readyState===4&&http.status===200){var audioArr=http.response;for(var i=0;i<audioArr.length;i++){var id=i;if(audioArr[id]){localforage.setItem("audio-"+i,{data:audioArr[id].data,name:audioArr[id].name})}}localforage.setItem("downloaded",audioArr.length,function(err){if(err){console.log("error: ",err);return}sequencer.audioTotal=audioArr.length;loadAudio()})}};http.open("GET","/audio",true);http.send()}function init(){localforage.getItem("downloaded",function(err,total){if(err||!total){downloadAudio();return}sequencer.audioTotal=total;loadAudio()})}init()}).call(this);