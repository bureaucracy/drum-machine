var Sample=function(){this.sound=false;this.name=false;this.context=new(window.AudioContext||window.webkitAudioContext);this.bpm=120};function toArrBuffer(base64){var binaryString=atob(base64);var len=binaryString.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)}return bytes.buffer}Sample.prototype={_toArrBuffer:function(data){var binaryString=atob(data);var len=binaryString.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)}this.sound=bytes.buffer},load:function(next){var self=this;localforage.getItem(this.name,function(err,audio){if(err){console.log("error: ",err);return}self.filename=audio.name;self._toArrBuffer(audio.data);next(self.filename)})},play:function(){var source=this.context.createBufferSource();var self=this;if(!this.name){console.log("no sound name/sample provided");return}this.load(function(){self.context.decodeAudioData(self.sound,function(buffer){source.buffer=buffer;source.connect(self.context.destination);source.start(0)})})}};var Track=function(){this.bpm=120;this.isPlaying=false;this.sounds={};this.samples={};this.timestamp=(new Date).getTime();this.currentNote=16;this.id=false};Track.prototype={_getBPM32:function(){var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;var note=Math.round(qtr/8*1e5)/1e5;return Math.round(note*1e5)/1e5},_getBPM16:function(){var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;var note=Math.round(qtr/4*1e5)/1e5;return Math.round(note*1e5)/1e5},_getBPM8:function(){var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;var note=Math.round(qtr/2*1e5)/1e5;return Math.round(note*1e5)/1e5},_getBPM4:function(){var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;var note=Math.round(qtr*1e5)/1e5;return Math.round(note*1e5)/1e5},_getBPM2:function(){var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;var note=Math.round(qtr*2*1e5)/1e5;return Math.round(note*1e5)/1e5},add:function(id,next){var self=this;this.sounds[id]={};this.samples[id]=new Sample;this.samples[id].name="audio-"+id;this.samples[id].bpm=this["_getBPM"+this.currentNote]();this.samples[id].load(function(filename){for(var i=0;i<16;i++){self.sounds[id][i]=false}console.log("loaded into track ",self.sounds);next(filename)})},stop:function(){var notes=document.querySelectorAll(".note");for(var i=0;i<notes.length;i++){notes[i].classList.remove("playing")}this.start=0;this.play=null},loop:function(id){this.stop();var counter=0;var self=this;var bpm=this["_getBPM"+this.currentNote]();this.isPlaying=true;this.play=function(){try{requestAnimationFrame(self.play)}catch(err){}var now=(new Date).getTime();var delta=now-self.timestamp;if(delta>=bpm){self.timestamp=now-delta%bpm;document.querySelector("#note-"+self.id+"-"+counter).classList.remove("playing");for(var i=0;i<Object.keys(self.samples).length;i++){if(self.sounds[i][counter]){self.samples[i].play()}}counter++;if(counter>31){counter=0}document.querySelector("#note-"+self.id+"-"+counter).classList.add("playing")}};this.play()}};var Sequencer=function(){this.bpm=120;this.tracks={};this.counter=0;this.isPlaying=false};Sequencer.prototype={_generateNoteSelector:function(){var select=document.createElement("select");select.classList.add("notes-current");select.id="note-change-"+this.counter;select.setAttribute("data-id",this.counter);var notes=[32,16,8,4,2];var option;for(var i=0;i<notes.length;i++){option=document.createElement("option");option.value=notes[i];option.textContent="1/"+notes[i];if(notes[i]===16){option.setAttribute("selected",true)}select.appendChild(option)}return select},addTrack:function(){var track=new Track;this.counter++;track.id=this.counter;var self=this;function generateButtons(row){var id=row.getAttribute("sound");var bars=document.createElement("div");bars.classList.add("bars-row");for(var i=0;i<32;i++){var bar=document.createElement("button");pos=i;bar.classList.add("bar");bar.id="bar-"+i;bar.setAttribute("pos",i);bar.onclick=function(){if(this.getAttribute("on")==="true"){this.setAttribute("on",false);track.sounds[id][this.getAttribute("pos")]=false}else{this.setAttribute("on",true);track.sounds[id][this.getAttribute("pos")]=true}};bars.appendChild(bar)}row.appendChild(bars)}var machine=document.querySelector("#machine");var footer=document.querySelector("#footer");var sequencerRow=document.createElement("div");sequencerRow.classList.add("sequencer");sequencerRow.id="sequencer-"+this.counter;var notes=document.createElement("div");notes.classList.add("notes");for(var i=0;i<32;i++){var span=document.createElement("span");span.textContent=i+1;var note=document.createElement("div");note.id="note-"+this.counter+"-"+i;note.classList.add("note");if(i===0){note.classList.add("playing")}note.appendChild(span);notes.appendChild(note)}sequencerRow.appendChild(notes);sequencerRow.appendChild(this._generateNoteSelector());var counter=0;for(var i=0;i<this.audioTotal;i++){track.add(i,function(filename){var sampleRow=document.createElement("div");sampleRow.classList.add("sample");sampleRow.id="sample-"+counter;sampleRow.setAttribute("sound",counter);var span=document.createElement("span");span.textContent=filename;sampleRow.appendChild(span);generateButtons(sampleRow);sequencerRow.appendChild(sampleRow);counter++})}this.tracks[this.counter]=track;machine.appendChild(sequencerRow)},stop:function(){this.isPlaying=false;for(var track in this.tracks){this.tracks[track].stop()}},play:function(){this.isPlaying=true;for(var track in this.tracks){this.tracks[track].stop();this.tracks[track].bpm=this.bpm;this.tracks[track].loop()}}};(function(){window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame;var sequencer=new Sequencer;sequencer.audioTotal=0;function setNoteChanger(){var id=sequencer.counter;document.querySelector("#note-change-"+id).onchange=function(ev){sequencer.tracks[ev.target.getAttribute("data-id")].currentNote=this.value;if(sequencer.isPlaying){sequencer.play()}}}function loadAudio(){sequencer.addTrack();setNoteChanger();document.querySelector("#bpm").onchange=function(){var bpm=parseInt(this.value,10);if(isNaN(bpm)||bpm>500){this.value=120}sequencer.bpm=this.value;if(sequencer.isPlaying){sequencer.play()}};document.querySelector(".notes-current").onchange=function(ev){sequencer.tracks[ev.target.getAttribute("data-id")].currentNote=this.value;if(sequencer.isPlaying){sequencer.play()}};document.querySelector("#new-track").onclick=function(){sequencer.addTrack();setNoteChanger()};document.querySelector("#play").onclick=function(){sequencer.play()};document.querySelector("#pause").onclick=function(){sequencer.stop()};document.querySelector("#loader").classList.add("hide")}function downloadAudio(){var http=new XMLHttpRequest;http.responseType="json";http.onreadystatechange=function(){if(http.readyState===4&&http.status===200){var audioArr=http.response;for(var i=0;i<audioArr.length;i++){var id=i;if(audioArr[id]){localforage.setItem("audio-"+i,{data:audioArr[id].data,name:audioArr[id].name},function(err){if(err){console.log("error: ",err)}})}}localforage.setItem("downloaded",audioArr.length,function(err){if(err){console.log("error: ",err);return}sequencer.audioTotal=audioArr.length;loadAudio()})}};http.open("GET","/audio",true);http.send()}function init(){localforage.getItem("downloaded",function(err,total){if(err||!total){downloadAudio();return}sequencer.audioTotal=total;loadAudio()})}init()}).call(this);