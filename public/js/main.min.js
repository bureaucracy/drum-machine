var Sample=function(){this.sound=false;this.name=false;document.querySelector("#wrapper").addEventListener("play",function(event){event.detail.sample.play()},false)};Sample.prototype={_toArrBuffer:function(data){var binaryString=atob(data);var len=binaryString.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)}this.sound=bytes.buffer},load:function(next){var self=this;localforage.getItem(this.name,function(err,audio){if(err){console.log("error: ",err);return}self.filename=audio.name;self._toArrBuffer(audio.data);next(self.filename)})},play:function(){var source=audioContext.createBufferSource();var self=this;if(!this.name){console.log("no sound name/sample provided");return}this.load(function(){audioContext.decodeAudioData(self.sound,function(buffer){source.buffer=buffer;source.connect(audioContext.destination);source.start(0)})})}};var Track=function(){this.sounds={};this.samples={};this.timestamp=(new Date).getTime();this.currentNote=16;this.counter=0;this.id=false;document.querySelector("#wrapper").addEventListener("track",function(event){if(this.currentNote===event.detail.note){this.play()}}.bind(this),false)};Track.prototype={_emit:function(what,detail){var event=new CustomEvent(what,{detail:detail});document.querySelector("#wrapper").dispatchEvent(event)},add:function(id,next){var self=this;this.sounds[id]={};this.samples[id]=new Sample;this.samples[id].name="audio-"+id;this.samples[id].load(function(filename){for(var i=0;i<16;i++){self.sounds[id][i]=false}next(filename)})},stop:function(){var notes=document.querySelectorAll(".note");for(var i=0;i<notes.length;i++){notes[i].classList.remove("playing")}this.counter=0},play:function(){document.querySelector("#note-"+this.id+"-"+this.counter).classList.remove("playing");for(var i=0;i<Object.keys(this.samples).length;i++){if(this.sounds[i][this.counter]){var detail={id:this.id,note:this.currentNote,sample:this.samples[i]};this._emit("play",detail)}}this.counter++;if(this.counter>31){this.counter=0}document.querySelector("#note-"+this.id+"-"+this.counter).classList.add("playing")}};var Sequencer=function(){this.bpm=120;this.tracks={};this.counter=0;this.isPlaying=false;this._notes=[2,4,8,16,32];function setBPM(nt){var noteCalc=nt/4;var qtr=Math.round(60/this.bpm*1e3*1e5)/1e5;if(noteCalc>0){noteCalc=qtr/noteCalc}else{noteCalc=qtr*noteCalc}return Math.round(noteCalc*1e5)/1e5}for(var i=0;i<this._notes.length;i++){this["timestamp"+this._notes[i]]=(new Date).getTime();Sequencer.prototype["_getBPM"+this._notes[i]]=setBPM.bind(this,this._notes[i])}};Sequencer.prototype={_generateNoteSelector:function(){var select=document.createElement("select");select.classList.add("notes-current");select.id="note-change-"+this.counter;select.setAttribute("data-id",this.counter);var notes=this._notes.reverse();var option;for(var i=0;i<notes.length;i++){option=document.createElement("option");option.value=notes[i];option.textContent="1/"+notes[i];if(notes[i]===16){option.setAttribute("selected",true)}select.appendChild(option)}return select},addTrack:function(){var track=new Track;this.counter++;track.id=this.counter;function setClick(id){if(this.getAttribute("on")==="true"){this.setAttribute("on",false);track.sounds[id][this.getAttribute("pos")]=false}else{this.setAttribute("on",true);track.sounds[id][this.getAttribute("pos")]=true}}function generateButtons(row){var id=row.getAttribute("sound");var bars=document.createElement("div");bars.classList.add("bars-row");for(var i=0;i<32;i++){var bar=document.createElement("button");pos=i;bar.classList.add("bar");bar.id="bar-"+i;bar.setAttribute("pos",i);bar.onclick=setClick.bind(bar,id);bars.appendChild(bar)}row.appendChild(bars)}var machine=document.querySelector("#machine");var footer=document.querySelector("#footer");var sequencerRow=document.createElement("div");sequencerRow.classList.add("sequencer");sequencerRow.id="sequencer-"+this.counter;var remove=document.createElement("button");remove.classList.add("delete");remove.setAttribute("data-id",this.counter);remove.id="delete-"+this.counter;remove.textContent="x";sequencerRow.appendChild(remove);var notes=document.createElement("div");notes.classList.add("notes");for(var i=0;i<32;i++){var span=document.createElement("span");span.textContent=i+1;var note=document.createElement("div");note.id="note-"+this.counter+"-"+i;note.classList.add("note");if(i===0){note.classList.add("playing")}note.appendChild(span);notes.appendChild(note)}sequencerRow.appendChild(notes);sequencerRow.appendChild(this._generateNoteSelector());var counter=0;function addSample(j){var self=this;track.add(j,function(filename){var sampleRow=document.createElement("div");sampleRow.classList.add("sample");sampleRow.id="sample-"+counter;sampleRow.setAttribute("sound",counter);var span=document.createElement("span");span.textContent=filename;sampleRow.appendChild(span);generateButtons.call(self,sampleRow);sequencerRow.appendChild(sampleRow);counter++})}for(var j=0;j<this.audioTotal;j++){addSample.call(this,j)}this.tracks[this.counter]=track;machine.appendChild(sequencerRow);this.play()},stop:function(){this.isPlaying=false;for(var track in this.tracks){this.tracks[track].stop()}this.playTrack=null},_emit:function(what,detail){var event=new CustomEvent(what,{detail:detail});document.querySelector("#wrapper").dispatchEvent(event)},play:function(){this.stop();this.isPlaying=true;function setTimer(notes){var now=(new Date).getTime();var delta={};for(var i=0;i<this._notes.length;i++){var note=this._notes[i];delta[note]=now-this["timestamp"+note];if(delta[note]>=this["_getBPM"+note]()){this["timestamp"+note]=now-delta[note]%this["_getBPM"+note]();this._emit("track",{note:note})}}}this.playTrack=function(){try{requestAnimationFrame(this.playTrack.bind(this))}catch(err){}setTimer.call(this)};this.playTrack()},remove:function(id){this.tracks[id].stop();delete this.tracks[id];var seq=document.querySelector("#sequencer-"+id);seq.parentNode.removeChild(seq)}};(function(){var Context=window.AudioContext||window.webkitAudioContext;window.audioContext=new Context;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame;var sequencer=new Sequencer;sequencer.audioTotal=0;function setNoteChanger(){var id=sequencer.counter;document.querySelector("#note-change-"+id).onchange=function(ev){sequencer.tracks[ev.target.getAttribute("data-id")].currentNote=parseInt(this.value,10);if(sequencer.isPlaying){sequencer.play()}};document.querySelector("#delete-"+id).onclick=function(ev){sequencer.remove(ev.target.getAttribute("data-id"))}}function loadAudio(){sequencer.addTrack();setNoteChanger();document.querySelector("#bpm").onchange=function(){var bpm=parseInt(this.value,10);if(isNaN(bpm)||bpm>500){this.value=120}sequencer.bpm=this.value;if(sequencer.isPlaying){sequencer.play()}};document.querySelector(".notes-current").onchange=function(ev){sequencer.tracks[ev.target.getAttribute("data-id")].currentNote=parseInt(this.value,10);if(sequencer.isPlaying){sequencer.play()}};document.querySelector("#new-track").onclick=function(){sequencer.addTrack();setNoteChanger()};document.querySelector("#play").onclick=function(){sequencer.play()};document.querySelector("#pause").onclick=function(){sequencer.stop()};document.querySelector("#loader").classList.add("hide")}function downloadAudio(){var http=new XMLHttpRequest;http.responseType="json";http.onreadystatechange=function(){if(http.readyState===4&&http.status===200){var audioArr=http.response;for(var i=0;i<audioArr.length;i++){var id=i;if(audioArr[id]){localforage.setItem("audio-"+i,{data:audioArr[id].data,name:audioArr[id].name},function(err){if(err){console.log("error: ",err)}})}}localforage.setItem("downloaded",audioArr.length,function(err){if(err){console.log("error: ",err);return}sequencer.audioTotal=audioArr.length;loadAudio()})}};http.open("GET","/audio",true);http.send()}function init(){localforage.getItem("downloaded",function(err,total){if(err||!total){downloadAudio();return}sequencer.audioTotal=total;loadAudio()})}init()}).call(this);